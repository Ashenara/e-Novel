{{ define "main" }}
<div class="container mx-auto px-4 md:px-4 py-8">
    {{ partial "components/breadcrumb.html" . }}

    <div class="mt-4 md:mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8 xl:gap-12">

        <!-- Left Column (Sticky Sidebar on Large Screens) -->
        <aside class="lg:col-span-4 xl:col-span-3">
            <div class="lg:sticky lg:top-8 space-y-6">

                <!-- Novel Cover -->
                <div class="shrink-0">
                    <img src="{{ with .Params.image }}{{ . | relURL }}{{ else }}
                    {{ "https://placehold.co/400x600/27272A/FFFFFF?text=Novel+Cover" }}{{ end }}"
                        alt="Novel Cover for {{ .Title }}" class="w-full h-auto rounded-xl shadow-lg object-cover"
                        onerror="this.onerror=null;this.src='https://placehold.co/400x600/CCCCCC/666666?text=Image+Missing';">
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col space-y-3">
                    {{ $firstChapter := first 1 (.Pages.ByParam "chapter_number") }}
                    {{ with $firstChapter }}
                    {{ range . }}
                    <a href="{{ .Permalink }}"
                        class="w-full text-center bg-(--color-primary) text-white px-6 py-3 rounded-lg font-bold text-lg hover:bg-(--color-primary-hover) transition-colors shadow-md transform hover:-translate-y-0.5">Start
                        Reading</a>
                    {{ end }}
                    {{ else }}
                    {{ with .Params.download }}
                    <a href="{{ . | relURL }}" target="_blank"
                        class="w-full text-center bg-(--color-primary) text-white px-6 py-3 rounded-lg font-bold text-lg hover:bg-(--color-primary-hover) transition-colors shadow-md transform hover:-translate-y-0.5">Download</a>
                    {{ end }}
                    {{ end }}
                    <!-- MODIFIED Add to Library Button -->
                    <button id="add-to-library-btn" data-novel-id="{{ .File.UniqueID | default (.Title | urlize) }}"
                        data-novel-title="{{ .Title }}" data-novel-permalink="{{ .Permalink | absURL }}"
                        data-novel-image="{{ with .Params.image }}{{ . | absURL }}{{ else }}
                        {{ "https://placehold.co/400x600/27272A/FFFFFF?text=Novel+Cover" }}{{ end }}"
                        data-novel-status="{{ with .Params.status }}{{ if reflect.IsSlice . }}{{ index . 0 }}{{ else }}{{ . }}{{ end }}{{ end }}"
                        data-novel-genres="{{ with .Params.genres }}{{ delimit . " ," }}{{ end }}"
                        class="w-full text-center bg-(--color-muted) text-(--color-muted-foreground) px-6 py-3 rounded-lg font-bold text-lg hover:bg-opacity-80 transition-colors shadow-md transform hover:-translate-y-0.5"
                        disabled>
                        Add to Library
                    </button>
                    <p id="library-status" class="text-xs text-center text-(--color-muted-foreground) h-4"></p>
                </div>

                <!-- Metadata Block -->
                <div class="bg-(--color-card) p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-(--color-foreground) mb-4 border-b border-(--color-border) pb-2">
                        Details</h3>
                    <ul class="space-y-3 text-(--color-muted-foreground)">
                        {{ with .Params.writer }}
                        <li class="flex justify-between items-center">
                            <span>Author:</span>
                            {{ range . }}
                            <a href="{{ printf " /writer/%s/" (. | urlize) | relURL }}"
                                class="ml-2 px-2 py-1 bg-(--color-alt-tag-bg) text-(--color-alt-tag-text) text-xs font-semibold rounded-full hover:bg-(--color-primary) hover:text-white transition-colors">
                                {{ . }}
                            </a>
                            {{ end }}
                        </li>
                        {{ end }}
                        {{ with .Params.translator }}<li class="flex justify-between items-center">
                            <span>Translator:</span> <strong class="text-(--color-foreground) text-right">{{ .
                                }}</strong></li>{{ end }}
                        {{ with .Params.origin }}
                        <li class="flex justify-between items-center">
                            <span>Origin:</span>
                            <strong class="text-(--color-foreground) text-right">
                                {{ if reflect.IsSlice . }}{{ index . 0 }}{{ else }}{{ . }}{{ end }}
                            </strong>
                        </li>
                        {{ end }}
                        {{ with .Params.chapter }}<li class="flex justify-between items-center">
                            <span>Chapters:</span><strong class="text-(--color-foreground) text-right">{{ . }}</strong>
                        </li>{{ end }}
                        {{ with .Params.status }}
                        <li class="flex justify-between items-center">
                            <span>Status:</span>
                            <strong class="text-(--color-foreground) text-right">
                                {{ if reflect.IsSlice . }}{{ index . 0 }}{{ else }}{{ . }}{{ end }}
                            </strong>
                        </li>
                        {{ end }}
                        {{ with .PublishDate }}<li class="flex justify-between items-center"><span>Date
                                Added:</span><strong class="text-(--color-foreground) text-sm text-right">{{ .Format
                                "Jan 2, 2006" }}</strong></li>{{ end }}
                    </ul>
                </div>

                <!-- Genres & Tags -->
                <div class="bg-(--color-card) p-4 rounded-lg shadow-md">
                    {{ with .Params.genres }}
                    <h3 class="text-lg font-bold text-(--color-foreground) mb-3">Genres</h3>
                    <div class="flex flex-wrap gap-2">
                        {{ range . }}
                        <a href="{{ printf " /genres/%s/" (. | urlize) | relURL }}"
                            class="bg-(--color-tag-bg) text-(--color-tag-text) text-sm font-medium px-3 py-1 rounded-full hover:bg-(--color-primary) hover:text-white transition-colors">{{
                            . }}</a>
                        {{ end }}
                    </div>
                    {{ end }}

                    {{ with .Params.tags }}
                    <h3 class="text-lg font-bold text-(--color-foreground) mb-3 mt-4">Tags</h3>
                    <div class="flex flex-wrap gap-2">
                        {{ range . }}
                        <a href="{{ printf " /tags/%s/" (. | urlize) | relURL }}"
                            class="bg-(--color-alt-tag-bg) text-(--color-alt-tag-text) text-sm font-medium px-3 py-1 rounded-full hover:bg-(--color-primary) hover:text-white transition-colors">{{
                            . }}</a>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>

            </div>
        </aside>

        <!-- Right Column (Main Content) -->
        <main class="lg:col-span-8 xl:col-span-9 space-y-12">

            <!-- Title and Summary -->
            <section class="bg-(--color-card) rounded-lg md:shadow-xl px-0 py-6 md:p-8">
                <h1 class="text-3xl md:text-4xl font-bold text-(--color-foreground) mb-2 leading-tight">
                    {{ .Title }}
                </h1>
                {{ with .Params.alt_titles }}
                <p class="text-md text-(--color-muted-foreground) mb-4 italic">
                    Also known as: {{ delimit . ", " }}
                </p>
                {{ end }}
                {{ with .Params.writer }}
                <div class="flex items-center text-lg text-(--color-muted-foreground) mb-6">
                    <span>by</span>
                    {{ range . }}
                    <a href="{{ printf " /writer/%s/" (. | urlize) | relURL }}"
                        class="ml-2 px-3 py-1 bg-(--color-alt-tag-bg) text-(--color-alt-tag-text) text-sm font-semibold rounded-full hover:bg-(--color-primary) hover:text-white transition-colors">{{
                        . }}</a>
                    {{ end }}
                </div>
                {{ end }}

                <h2 class="text-2xl font-bold text-(--color-foreground) mt-8 mb-4 border-b border-(--color-border) pb-3">
                    Synopsis</h2>
                <div class="prose dark:prose-invert max-w-none text-(--color-muted-foreground)">
                    {{ .Content }}
                </div>
            </section>

            <!-- ... The rest of the file is correct ... -->
            <section id="chapter-list" class="bg-(--color-card) rounded-lg shadow-xl p-6 md:p-8">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                    <h2 class="text-2xl font-bold text-(--color-foreground) mb-4 sm:mb-0">Chapter List</h2>
                    <div class="flex space-x-2">
                        <button id="sort-newest"
                            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">Newest</button>
                        <button id="sort-oldest"
                            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">Oldest</button>
                    </div>
                </div>
                {{ $chapters := .Pages.ByParam "chapter_number" }}
                {{ if $chapters }}
                <div id="chapter-chunks-container" class="space-y-2">
                    {{ $chunkSize := 250 }}
                    {{ $numChapters := len $chapters }}
                    {{ $numChunks := int (math.Ceil (div (float $numChapters) (float $chunkSize))) }}
                    {{ range $i := seq (sub $numChunks 1) -1 0 }}
                    {{ $chunkIndex := $i }}
                    {{ $startRange := mul $chunkIndex $chunkSize }}
                    {{ $chunkChapters := after $startRange $chapters | first $chunkSize }}
                    {{ with $chunkChapters }}
                    {{ $firstChapterInChunk := index . 0 }}
                    {{ $lastChapterInChunk := index (last 1 .) 0 }}
                    <div class="chapter-chunk border border-(--color-border) rounded-lg overflow-hidden"
                        data-chunk-index="{{ $chunkIndex }}">
                        <button
                            class="chunk-header w-full flex justify-between items-center p-4 bg-(--color-muted) hover:bg-opacity-80 transition-colors">
                            <span class="font-bold text-lg text-(--color-foreground)">
                                Chapters {{ $firstChapterInChunk.Params.chapter_number }} - {{
                                $lastChapterInChunk.Params.chapter_number }}
                            </span>
                            <svg class="w-5 h-5 text-(--color-muted-foreground) transition-transform transform"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="chunk-content hidden p-2">
                            <ul class="space-y-1">
                                {{ range . }}
                                <li data-chapter-number="{{ .Params.chapter_number }}"
                                    class="border-b border-(--color-border) last:border-b-0">
                                    <a href="{{ .RelPermalink }}"
                                        class="block p-3 rounded-lg transition-colors text-(--color-muted-foreground) hover:bg-(--color-muted) hover:text-(--color-foreground)">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Chapter {{ .Params.chapter_number }}: {{ .Title
                                                }}</span>
                                            <span class="text-xs text-right ml-4">{{ .PublishDate.Format "Jan 2, 2006"
                                                }}</span>
                                        </div>
                                    </a>
                                </li>
                                {{ end }}
                            </ul>
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                </div>
                {{ else }}
                <div class="text-center py-8 bg-(--color-muted) rounded-lg">
                    <p class="text-(--color-muted-foreground)">No chapters have been published yet.</p>
                </div>
                {{ end }}
            </section>
        </main>
    </div>
    <section class="mt-16">
        <h2 class="text-3xl font-bold text-(--color-foreground) mb-6 text-center">More novels with similar genres</h2>
        <div class="flex flex-nowrap overflow-x-auto pb-4 hide-scrollbar space-x-4">
            {{ $currentNovelPermalink := .Permalink }}
            {{ $currentNovelGenres := .Params.genres }}
            {{ if $currentNovelGenres }}
            {{ $allNovels := where (where site.Pages "Section" "novels") "IsNode" true }}
            {{ $allNovels = where $allNovels "Params.excludeFromLists" "!=" true }}
            {{ $relatedNovels := slice }}
            {{ range $allNovels }}
            {{ if ne .Permalink $currentNovelPermalink }}
            {{ $otherNovelGenres := .Params.genres }}
            {{ if gt (len (intersect $otherNovelGenres $currentNovelGenres)) 0 }}
            {{ $relatedNovels = $relatedNovels | append . }}
            {{ end }}
            {{ end }}
            {{ end }}
            {{ $finalRelatedNovels := first 12 (shuffle $relatedNovels) }}
            {{ if $finalRelatedNovels }}
            {{ range $finalRelatedNovels }}
            {{ partial "card/novel-card.html" . }}
            {{ end }}
            {{ else }}
            <p class="text-(--color-muted-foreground) shrink-0">No other novels found with similar genres.</p>
            {{ end }}
            {{ end }}
        </div>
    </section>
    {{ if .Site.Params.enableComments }}

    <section>
        {{ $pageId := .File.UniqueID }}
        {{ $pageData := dict "pageId" $pageId "pageTitle" .Title "pageUrl" .Permalink }}
        {{ partial "firebase/comments-firebase.html" $pageData }}
    </section>

    {{ end }}
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chunkHeaders = document.querySelectorAll('.chunk-header');
        chunkHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('svg');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        });
        const sortOldestBtn = document.getElementById('sort-oldest');
        const sortNewestBtn = document.getElementById('sort-newest');
        const chunksContainer = document.getElementById('chapter-chunks-container');
        if (sortNewestBtn && sortOldestBtn && chunksContainer) {
            const sortChapters = (order) => {
                const chunks = Array.from(chunksContainer.children);
                chunks.sort((a, b) => {
                    const indexA = parseInt(a.dataset.chunkIndex, 10);
                    const indexB = parseInt(b.dataset.chunkIndex, 10);
                    return order === 'newest' ? indexB - indexA : indexA - indexB;
                });
                chunksContainer.innerHTML = '';
                chunks.forEach(chunk => {
                    const list = chunk.querySelector('ul');
                    if (list) {
                        const items = Array.from(list.children);
                        items.sort((a, b) => {
                            const chapterA = parseInt(a.dataset.chapterNumber, 10);
                            const chapterB = parseInt(b.dataset.chapterNumber, 10);
                            return order === 'newest' ? chapterB - chapterA : chapterA - chapterB;
                        });
                        list.innerHTML = '';
                        items.forEach(item => list.appendChild(item));
                    }
                    chunksContainer.appendChild(chunk);
                });
                updateSortButtons(order);
                localStorage.setItem('chapterSortOrder', order);
            };
            const updateSortButtons = (activeOrder) => {
                const activeClasses = ['bg-(--color-primary)', 'text-white'];
                const inactiveClasses = ['bg-(--color-muted)', 'text-(--color-muted-foreground)', 'hover:bg-opacity-80'];
                [sortNewestBtn, sortOldestBtn].forEach(btn => btn.classList.remove(...activeClasses, ...inactiveClasses));
                if (activeOrder === 'newest') {
                    sortNewestBtn.classList.add(...activeClasses);
                    sortOldestBtn.classList.add(...inactiveClasses);
                } else {
                    sortOldestBtn.classList.add(...activeClasses);
                    sortNewestBtn.classList.add(...inactiveClasses);
                }
            };
            sortNewestBtn.addEventListener('click', () => sortChapters('newest'));
            sortOldestBtn.addEventListener('click', () => sortChapters('oldest'));
            const savedOrder = localStorage.getItem('chapterSortOrder') || 'newest';
            updateSortButtons(savedOrder);
            if (savedOrder === 'oldest') {
                sortChapters('oldest');
            }
        } else {
            console.warn("Chapter sorting elements not found. Sorting will not be initialized.");
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const checkFirebase = setInterval(() => {
            if (typeof auth !== 'undefined' && typeof db !== 'undefined') {
                clearInterval(checkFirebase);
                initNovelPage();
            }
        }, 100);

        function initNovelPage() {
            const libraryBtn = document.getElementById('add-to-library-btn');
            const libraryStatus = document.getElementById('library-status');
            const startReadingBtn = document.getElementById('start-reading-btn');

            const novelId = libraryBtn.dataset.novelId;

            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is logged in, enable the button
                    libraryBtn.disabled = false;
                    const libraryDocRef = db.collection('users').doc(user.uid).collection('library').doc(novelId);

                    // Check if this novel is already in the library and update UI
                    libraryDocRef.onSnapshot(doc => {
                        if (doc.exists) {
                            libraryBtn.textContent = 'In Library ✔️';
                            libraryBtn.classList.add('bg-green-600', 'text-white');
                            libraryBtn.classList.remove('bg-(--color-muted)', 'text-(--color-muted-foreground)');
                            libraryBtn.onclick = () => removeFromLibrary(user.uid, novelId);
                        } else {
                            libraryBtn.textContent = 'Add to Library';
                            libraryBtn.classList.remove('bg-green-600', 'text-white');
                            libraryBtn.classList.add('bg-(--color-muted)', 'text-(--color-muted-foreground)');
                            libraryBtn.onclick = () => addToLibrary(user.uid);
                        }
                    });



                } else {
                    // User is not logged in
                    libraryBtn.disabled = false;
                    libraryStatus.textContent = 'Login to add to library';
                    libraryBtn.addEventListener('click', () => {
                        window.location.href = '{{ "/login" | relURL }}';
                    });
                }
            });

            function addToLibrary(uid) {
                // We grab all the data from our button's attributes
                const novelData = {
                    title: libraryBtn.dataset.novelTitle,
                    permalink: libraryBtn.dataset.novelPermalink,
                    image: libraryBtn.dataset.novelImage,
                    status: libraryBtn.dataset.novelStatus,
                    genres: libraryBtn.dataset.novelGenres,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                db.collection('users').doc(uid).collection('library').doc(novelId).set(novelData)
                    .then(() => console.log('Added to library with full details!'))
                    .catch(e => console.error('Error adding: ', e));
            }

            function removeFromLibrary(uid, novelId) {
                db.collection('users').doc(uid).collection('library').doc(novelId).delete()
                    .then(() => console.log('Removed from library!'))
                    .catch(e => console.error('Error removing: ', e));
            }


        }
    });

</script>
{{ end }}